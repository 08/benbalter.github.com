{"author":"Benjamin J. Balter","title":"Regular Expression to Parse Word-style Footnotes into WordPress's Simple Footnotes Format","excerpt":"Regular Expression to automatically parse Microsoft Word's footnote format into a more web-friendly format for WordPress's Simple Footnotes plugin.","layout":"post","category":["Technology"],"tags":["code","footnotes","hack","open source","plugin","wordpress"],"post_format":[],"url":"/2011/03/20/regular-expression-to-parse-word-style-footnotes/","date":"2011-03-20 00:00:00 -0400","id":"/2011/03/20/regular-expression-to-parse-word-style-footnotes","categories":["posts"],"next":"[![Golden Hammer][2]][2]\n\nMy biggest gripe with [WordPress][2], the open-source [content management system][3] that silently works behind the scenes to power [more than 13%][4] of the Internet, is that it sets far too high a bar with which other applications must compete. I cannot count the number of times that I have used a proprietary or commercial system and silently thought to myself, \"*WordPress can do this so much better*.\" [^1]\n\nThis ritual saw no deviation, when I sat down to setup [SharePoint][6] in support of my [law journal][7]‘s upcoming publication workflow. Like Alice stumbling down the rabbit hole, it quickly became apparent that in the counterintuitive world of Sharepoint, each step was going to be more and more alien than the last. And then it dawned on me: a corollary of [Uncle Ben's law][8], *with great power does not have to come great complexity*.\n\nWordPress does many things right. It is an incredibly versatile tool, but like a body builder with a heart of gold, it is as friendly and approachable as it is powerful. WordPress has [more than eight years of rock-solid experience][9] storing, organizing, sorting, and searching all sorts of user-generated content. Its got a set of slick attachment functions to allow users to safely and securely upload and store their non-WordPress files in WordPress. For the past three years, it even has a proto-version control system in the form of its much-envied [post revisions][10]. [^2] And it does all this through an interface so dumb-simple that [even your grandparents could start their own site][12]. It seems like a no brainer then, to marry these tools to create a WordPress-based document management system.\n\nImagine a workflow management and version control system [building on WordPress's existing core competencies][13]. By treating documents as a custom post type, users can leverage the power of WordPress's extensive attachment, revision, taxonomy, and URL rewriting functionalities. Document permalinks can be routed through the traditional rewrite structure such that the latest revision of a file always remains at a static, authenticated URL, and users can toggle the visibility of documents (both internally and externally) as they currently do with post statuses and permissions. Similarly, file locking can extend WordPress's autosave functionality (as a ping), revision logs can extend WordPress's existing revision relationship and can be outputted as a traditional RSS feed, etc.\n\n![][14]\n\nAs seen in the above wireframe, document revisions would be inextricably linked to the essential WordPress experience. If you know WordPress, you know document revisions. Why reinvent the wheel when you have the best wheel the world has ever seen, and a passionate global community dedicated to improving it? This approach would not simply be limited to traditional documents. Images, PDFs, code — anything the user wants to collaborate with others on, or have a secure revision history can be thrown at it. Academics, lawyers, government folks, the possibilities are endless.\n\nTo be fair, WordPress has been arguably overextended in some cases, [^3] but I do not believe that to be the case here. Sure any WordPress enthusiast may be guilty of the [bolt-cutter mentality][16] every now and then, but I believe, if anything, it is enterprise stakeholders' tendency to gravitate toward bloated, commercial systems that is more akin to Wolf Blitzer's boat house, and a big reason why is because with the exception of an unnamed [^4] content management system's poorly executed attempt at document management, no open-source alternatives exist.\n\nI am working on submitting this idea as a proposed [Google Summer of Code][18] project, [^5] with the goal of giving WordPress parity with commercial and proprietary applications and hopefully injecting some open-source goodness into government and other enterprise environments, but before I do, I would love to hear your thoughts. [Get in touch][20], or [leave a comment below][21].\n\n**Update (8/29)**: The final result of the project is an [Open Source Document Management and Version Control System][22] for WordPress. An overview of its top-level features including a screencast of a typical use case is available on the [WP Document Revisions][22] page.\n\nNotes:\n\n[^1]: *See, e.g., *[Documentum][23], [Liferay][24], [Melange][25], and [Gawker's CMS][26]. [27]\n[^2]: Nearly three years ago, at the time of the feature's inception, [WordPress founder Matt Mullenweg noted][28], \"*With the power of modern computers, it's silly that we still use save and editing metaphors from the time when the most common method of storage was floppy disks… now we're taking that to another level by allowing you to view who made what changes when… through a super-easy interface, much like Wikipedia or a version control system.*\" [29]\n[^3]: *See, e.g., *WordPress as an [e-mail newsletter][30], [contact manager][31], [CRM][32], [task list][33], [invoice system][34],  [job bank][35], or [real estate directory][36]. [37]\n[^4]: Let's just call it \"Frupal\" for the sake of discussion. [38]\n[^5]: In hindsight, I probably shouldn't have ripped on Melange. *See supra note 1.* [39]\n\n []: http://xkcd.com/801/\n [2]: http://wordpress.org\n [3]: http://en.wikipedia.org/wiki/Content_management_system\n [4]: http://w3techs.com/technologies/overview/content_management/all\n [5]: #note-2020-1 \"See, e.g., Documentum, Liferay, Melange, and Gawker's CMS.\"\n [6]: http://en.wikipedia.org/wiki/Microsoft_SharePoint\n [7]: http://pcjl.org\n [8]: http://www.youtube.com/watch?v=8DfztIIqbTI#t=1m3s\n [9]: http://core.trac.wordpress.org/browser/trunk?rev=3\n [10]: http://codex.wordpress.org/Revision_Management\n [11]: #note-2020-2 \"Nearly three years ago, at the time of the feature's inception, WordPress founder Matt Mullenweg noted, \"With the power of modern computers, it's silly that we still use save and editing metaphors from the time when the most common method of storage was floppy disks… now we're taking that to another level by allowing you to view who made what changes when… through a super-easy interface, much like Wikipedia or a version control system.\"\"\n [12]: http://www.thegrandparentsblog.com/\n [13]: http://lists.automattic.com/pipermail/wp-hackers/2011-March/038727.html\n [14]: http://ben.balter.com/wp-content/uploads/2011/04/wireframe.png \"WP Document Revisions Wireframe\"\n [15]: #note-2020-3 \"See, e.g., WordPress as an e-mail newsletter, contact manager, CRM, task list, invoice system,  job bank, or real estate directory.\"\n [16]: http://xkcd.com/801\n [17]: #note-2020-4 \"Let's just call it \"Frupal\" for the sake of discussion.\"\n [18]: http://www.google-melange.com/gsoc/homepage/google/gsoc2011\n [19]: #note-2020-5 \"In hindsight, I probably shouldn't have ripped on Melange. See supra note 1.\"\n [20]: http://ben.balter.com/contact/\n [21]: #comments\n [22]: http://ben.balter.com/2011/08/29/document-management-version-control-for-wordpress/\n [23]: http://www.emc.com/domains/documentum/index.htm\n [24]: http://www.liferay.com/\n [25]: http://code.google.com/p/soc/wiki/MelangeIntro\n [26]: http://www.mediaite.com/online/worse-than-previously-thought-gawker-content-management-system-hacked/\n \n [28]: http://wordpress.org/news/2008/07/wordpress-26-tyner/\n \n [30]: http://net.tutsplus.com/tutorials/wordpress/build-a-wordburner-email-newsletter-manager-using-wordpress-and-feedburner/\n [31]: http://publisherblog.automattic.com/2008/02/13/wp-contact-manager/\n [32]: http://slipfire.com/wp-crm/\n [33]: http://wordpress.org/extend/plugins/wp-task-manager/\n [34]: http://wordpress.org/extend/plugins/wp-invoice/\n [35]: http://wordpress.org/extend/plugins/job-manager/\n [36]: http://wordpress.org/extend/plugins/great-real-estate/","previous":"<p>I gave a brief talk at March&#8217;s joint <a href='http://www.meetup.com/wordpressdc/events/16178194/'>WordPressDC and Hacks/Hackers DC MeetUp</a> on leveraging WordPress to craft your personal brand. Below are slides and a recording of the livestream.</p>\n\n<p><strong>I invite you to watch, but in short, the main takeaways were:</strong></p>\n\n<ul>\n<li><img alt='Why Brand?' src='http://ben.balter.com/wp-content/uploads/2011/03/branding-300x224.png' />In the olden days, people used to be scared to put personal information online; they felt the need to be pseudonymous (<em>see</em> handles like SparklePrincess87); life online was distinct from life offline.</li>\n\n<li>As more of our analog lives became digital, the need for a second identity diminished; we no longer represent ourselves with anonymous screen names, but rather as ourselves.</li>\n\n<li>Social networking and mobile computing contributed to this shift by interfacing the online and offline worlds. Today&#8217;s radical transparency (<em>e.g.,</em> lifecasters posting pictures of their lunch) shows we have come a full 180.</li>\n\n<li>We shift from corporate brand associations in the 50s (<em>e.g.,</em> &#8220;I work for IBM&#8221;) to personal brands today (<em>e.g.,</em> &#8221;I&#8217;m an independent contractor&#8221;).</li>\n\n<li>Today we all have a unique opportunity to plant a flag on our corner of the internet, take control of our online identity, and declare to the world who we are by crafting a thought-out narrative.</li>\n\n<li>Unlike in the real world where you are the only one in control of what you say, online, content has a life of its own — you must be proactive.</li>\n\n<li>WordPress makes it dumb simple to tell the world your story.</li>\n</ul>\n\n<p><strong>My five big steps to launching your brand:</strong></p>\n\n<ol>\n<li>Grab a domain</li>\n\n<li>Define your personal brand</li>\n\n<li>Start a blog</li>\n\n<li>Socialize your content</li>\n\n<li>Upgrade your resume</li>\n</ol>\n\n<p><strong>Recording of the livestream:</strong></p>\n\n<p><em><a href='http://www.greglinch.com/'>Greg Linch</a> opens by discussing WordPress and Journalism, I begin at 30m 10s</em></p>\n\n<p><strong>Accompanying slides if you wish to follow along:</strong></p>\n\n<p><strong>For those interested in the plugins mentioned:</strong></p>\n\n<ul>\n<li><a href='http://ben.balter.com/2010/09/12/wordpress-resume-plugin/' title='WordPress Resume Plugin'>Resume Plugin for WordPress</a></li>\n\n<li><a href='http://ben.balter.com/2011/01/11/wordpress-emphasis-plugin/' title='WordPress Emphasis Plugin: Highlight and Permalink Text'>Emphasis Plugin for WordPress</a></li>\n\n<li><a href='http://wordpress.org/extend/plugins/all-in-one-seo-pack/'>All in One SEO</a></li>\n\n<li><a href='http://yoast.com/wordpress/google-analytics/'>Google Analytics for WordPress</a></li>\n\n<li><a href='http://wordpress.org/extend/plugins/simple-facebook-connect/'>Simple Facebook Connect</a></li>\n\n<li><a href='http://wordpress.org/extend/plugins/simple-twitter-connect/'>Simple Twitter Connect</a></li>\n\n<li><a href='http://wordpress.org/extend/plugins/subscribe-to-comments/'>Subscribe to Comments</a></li>\n\n<li><a href='http://wordpress.org/extend/plugins/syntaxhighlighter/'>Syntax Highlighter Evolved</a></li>\n</ul>\n\n<p><strong>Additional Resources:</strong></p>\n\n<ul>\n<li><a href='http://rapportive.com/'>Rapportive</a></li>\n\n<li><a href='http://thenextweb.com/socialmedia/2010/10/13/bit-ly-now-lets-you-add-qr-codes-to-links-in-seconds/'>How to generate a QR code</a></li>\n</ul>\n\n<p>A special thanks to everyone who was able to come out or follow along on the livestream.</p>\n\n<p>Comments? I&#8217;d love to hear your thoughts below.</p>","content":"<p>I needed a quick-and-easy way to parse Microsoft Word&#8217;s footnote format into a more web-friendly format for a recent project. After a bit of regular expression hacking, I was able to build a WordPress plugin to automatically convert content pasted from Word into a format readable by <a href='http://andrewnacin.com'>Andrew Nacin&#8217;s</a> popular <a href='http://andrewnacin.com/2010/07/24/simple-footnotes-0-3/'>Simple Footnotes</a> plugin.</p>\n\n<p>The process is surprisingly simple given <a href='http://codex.wordpress.org/Plugin_API/Filter_Reference'>WordPress&#8217;s extensive filter API</a>. First, to grab the footnotes from Word&#8217;s <code>ftnref</code> format:</p>\n\n<p>{% highlight php %}</p>\n\n<pre><code>//grab all the Word-style footnotes into an array\n$pattern = &#39;#&amp;lt;a href\\=&amp;quot;\\#_ftnref([0-9]+)&amp;quot;&amp;gt;\\[([0-9]+)\\]&amp;lt;/a&amp;gt; (.*)#&#39;;\npreg_match_all( $pattern, $content, $footnotes, PREG_SET_ORDER);</code></pre>\n\n<p>{% endhighlight %}</p>\n\n<p>This creates an array (<code>$footnotes</code>) with the both the footnote number and the text of the footnote. We then need a way to replace the in-text reference with the parsed footnotes so that Simple Footnotes can understand them. I did this by creating two arrays, a find array and a replace array with each Word-style footnote reference and its Simple Footnote formatted counterpart:</p>\n\n<p>{% highlight php %}</p>\n\n<pre><code>//build find and replace arrays\nforeach ($footnotes as $footnote) {\n    $find[] = &#39;#&amp;lt;a href\\=&amp;quot;\\#_ftn&#39;.$footnote[1].&#39;&amp;quot;&amp;gt;\\[&#39;.$footnote[1].&#39;\\]&amp;lt;/a&amp;gt;#&#39;;\n    $replace[] = &#39;[ref]&#39; . str_replace( array(&amp;quot;\\r\\n&amp;quot;, &amp;quot;\\r&amp;quot;, &amp;quot;\\n&amp;quot;), &amp;quot;&amp;quot;, $footnote[3]) . &#39;[/ref]&#39;;\n}</code></pre>\n\n<p>{% endhighlight %}</p>\n\n<p>Finally, so that the entire replacement can be done in a single pass, push a final find/replace pair into the end of the array, to remove the original footnotes:</p>\n\n<p>{% highlight php %}</p>\n\n<pre><code>//remove all the original footnotes when done\n$find[] = &#39;#&amp;lt;div&amp;gt;\\s*&amp;lt;a href\\=&amp;quot;\\#_ftnref([0-9]+)&amp;quot;&amp;gt;\\[([0-9]+)\\]&amp;lt;/a&amp;gt; (.*)\\s*&amp;lt;/div&amp;gt;\\s+#&#39;;\n$replace[] = &#39;&#39;;</code></pre>\n\n<p>{% endhighlight %}</p>\n\n<p>Because PHP&#8217;s <code>preg_replace</code> function can handle arrays, all we have to do is run a single function:</p>\n\n<p>{% highlight php %}</p>\n\n<pre><code>$content = preg_replace( $find, $replace, $content );</code></pre>\n\n<p>{% endhighlight %}</p>\n\n<p>Putting it all together, including a filter hook to call our function and a <code>meta_value</code> flag to prevent parsing on subsequent saves, the result is:</p>\n\n<p>{% highlight php %}</p>\n\n<pre><code>/*\nPlugin Name: Convert Footnotes\nPlugin URI: http://ben.balter.com/2011/03/20/regular-expression-to-parse-word-style-footnotes/\nDescription: Converts Word Footnotes to Simple Footnotes format. Requires Simple Footnotes installed, available at: http://wordpress.org/extend/plugins/simple-footnotes/\nVersion: 0.1\nAuthor: Benjamin J. Balter\nAuthor URI: http://ben.balter.com/\nRevised by Marc Chehab: http://www.marcchehab.org/\n*/\n\n/**\n * Function which uses regular expression to parse Microsoft Word footnotes\n * into WordPress&#39;s Simple Footnotes format\n *\n * @link http://ben.balter.com/2011/03/20/regular-expression-to-parse-word-style-footnotes/\n * @param string $content post content from filter hook\n * @returns string post content with parsed footnotes\n */\n\nfunction bb_parse_footnotes( $content ) {\n\n     global $post;\n     if ( !isset( $post ) )\n          return;\n\n     //if we have already parsed, kick\n     if ( get_post_meta($post-&amp;gt;ID, &#39;parsed_footnotes&#39;) )\n          return $content;\n\n     $content = stripslashes( $content );\n\n     //grab all the Word-style footnotes into an array\n     $pattern = &#39;/\\&amp;lt;a( title\\=\\&amp;quot;\\&amp;quot;)? href\\=\\&amp;quot;[^\\&amp;quot;]*\\#_ftnref([0-9]+)\\&amp;quot;\\&amp;gt;\\[([0-9]+)\\]\\&amp;lt;\\/a\\&amp;gt;(.*)/&#39;;\n     preg_match_all( $pattern, $content, $footnotes, PREG_SET_ORDER);\n\n     //build find and replace arrays\n     foreach ($footnotes as $footnote) {\n          $find[] = &#39;/\\&amp;lt;a( title\\=\\&amp;quot;\\&amp;quot;)? href\\=\\&amp;quot;[^\\&amp;quot;]*\\#_ftn&#39;.$footnote[2].&#39;\\&amp;quot;\\&amp;gt;(\\&amp;lt;strong\\&amp;gt;)?\\[&#39;.$footnote[2].&#39;\\](\\&amp;lt;\\/strong\\&amp;gt;)?\\&amp;lt;\\/a\\&amp;gt;/&#39;;\n          $replace[] = &#39; [^1]&#39;;\n     }\n\n     //remove all the original footnotes when done\n     $find[] = &#39;/\\&amp;lt;div\\&amp;gt;\\s*(\\&amp;lt;p\\&amp;gt;)?\\&amp;lt;a( title\\=\\&amp;quot;\\&amp;quot;)? href\\=\\&amp;quot;[^\\&amp;quot;]*\\#_ftnref([0-9]+)\\&amp;quot;\\&amp;gt;\\[([0-9]+)\\]\\&amp;lt;\\/a\\&amp;gt;(.*)\\s*\\&amp;lt;\\/div\\&amp;gt;\\s+/s&#39;;\n     $replace[] = &#39;&#39;;\n\n     //make the switch\n     $content = preg_replace( $find, $replace, $content );\n\n     //add meta so we know it has been parsed\n     add_post_meta($post-&amp;gt;ID, &#39;parsed_footnotes&#39;, true, true);\n\n     return addslashes($content);\n}\n\n\nadd_filter( &#39;content_save_pre&#39;, &#39;bb_parse_footnotes&#39; );</code></pre>\n\n<p>{% endhighlight %}</p>\n\n<p>To use, you can <a href='https://github.com/benbalter/Convert-Microsoft-Word-Footnotes-to-WordPress-Simple-Footnotes'>download the plugin file</a> and activate (be sure you already have <a href='http://andrewnacin.com/2010/07/24/simple-footnotes-0-3/'>Simple Footnotes</a> installed). Copy the content from Word, and Paste into the &#8221;<em>Paste from Word</em>&#8221; box (may need to toggle the &#8221;<a href='http://www.bloggingteacher.com/writing-posts-with-the-wordpress-visual-editor-the-kitchen-sink'><em>Kitchen Sink</em></a>&#8221;.</p>\n\n<p>Thoughts? Improvements? The above code solved a rather stubborn workflow problem in a project I was working on, and hopefully it can do the same for you. Feel free to use/improve the above code. <sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> You can even <a href='http://ben.balter.com/2011/03/20/regular-expression-to-parse-word-style-footnotes/'>Fork the plugin over on Github</a>.</p>\n\n<p>Notes:</p>\n<div class='footnotes'><hr /><ol><li id='fn:1'>\n<p>Licensed under <a href='http://wordpress.org/about/gpl/'>GPLv2</a> <span>11</span></p>\n<a href='#fnref:1' rev='footnote'>&#8617;</a></li></ol></div>"}